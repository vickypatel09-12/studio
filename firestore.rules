/**
 * @fileoverview Firestore Security Rules for Bachat Bank ERP System.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for Customers, MonthlyDeposits, and Loans.
 * Each customer can only access their own data. Settings are global and publicly readable,
 * but write-protected.
 *
 * Data Structure:
 * - /customers/{customerId}: Stores customer profiles.
 * - /customers/{customerId}/monthlyDeposits/{monthlyDepositId}: Stores monthly deposits for a customer.
 * - /customers/{customerId}/loans/{loanId}: Stores loan information for a customer.
 * - /settings/{settingId}: Stores global application settings.  It is assumed there is only one settings document.
 *
 * Key Security Decisions:
 * - Users can only create, read, update, and delete their own customer data.
 * - Monthly deposits and loans are scoped to their respective customers.
 * - Settings are publicly readable but not writable through the client.
 * - Listing of customer documents is not allowed to prevent data leakage.
 *
 * Denormalization for Authorization:
 * The 'customerId' is used as the document ID in the `/customers/{customerId}` collection.
 * The 'customerId' is also present as a field in documents within the `/customers/{customerId}/monthlyDeposits/{monthlyDepositId}`
 * and `/customers/{customerId}/loans/{loanId}` subcollections. This ensures that all authorization checks
 * can be performed efficiently without additional `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is authenticated.
     * @path N/A
     * @allow N/A
     * @deny Unauthenticated request
     * @principle Protects against unauthenticated requests
     */
    function isSignedIn() {
        return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document based on the provided userId.
     * @path N/A
     * @allow N/A
     * @deny User is not the owner
     * @principle Enforces document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the existing document based on the provided userId.
     *              Also verifies that the document exists to prevent modification of non-existent documents.
     * @path N/A
     * @allow N/A
     * @deny User is not the owner OR the document does not exist.
     * @principle Enforces document ownership for existing documents.
     */
    function isExistingOwner(userId) {
      return isSignedIn() && request.auth.uid == userId && existsAfter(/databases/$(database)/documents/customers/$(userId));
    }

    /**
     * @description Rules for the /customers/{customerId} collection.
     * @path /customers/{customerId}
     * @allow (create) Authenticated user creates a new customer with their own ID.
     * @deny (create) Authenticated user attempts to create a customer with a different ID.
     * @allow (get) Authenticated user gets their own customer profile.
     * @deny (get) Authenticated user attempts to get a different customer profile.
     * @allow (update) Authenticated user updates their own customer profile.
     * @deny (update) Authenticated user attempts to update a different customer profile.
     * @allow (delete) Authenticated user deletes their own customer profile.
     * @deny (delete) Authenticated user attempts to delete a different customer profile.
     * @principle Enforces document ownership for writes; restricts reads to owner.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;

      allow create: if isSignedIn() && request.auth.uid == customerId;
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Rules for the /customers/{customerId}/monthlyDeposits/{monthlyDepositId} collection.
     * @path /customers/{customerId}/monthlyDeposits/{monthlyDepositId}
     * @allow (create) Authenticated user creates a new monthly deposit for their own customer ID.
     * @deny (create) Authenticated user attempts to create a monthly deposit for a different customer ID.
     * @allow (get) Authenticated user gets their own monthly deposit.
     * @deny (get) Authenticated user attempts to get a different customer's monthly deposit.
     * @allow (update) Authenticated user updates their own monthly deposit.
     * @deny (update) Authenticated user attempts to update a different customer's monthly deposit.
     * @allow (delete) Authenticated user deletes their own monthly deposit.
     * @deny (delete) Authenticated user attempts to delete a different customer's monthly deposit.
     * @principle Enforces document ownership for writes; restricts reads to owner.
     */
    match /customers/{customerId}/monthlyDeposits/{monthlyDepositId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);

      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Rules for the /customers/{customerId}/loans/{loanId} collection.
     * @path /customers/{customerId}/loans/{loanId}
     * @allow (create) Authenticated user creates a new loan for their own customer ID.
     * @deny (create) Authenticated user attempts to create a loan for a different customer ID.
     * @allow (get) Authenticated user gets their own loan.
     * @deny (get) Authenticated user attempts to get a different customer's loan.
     * @allow (update) Authenticated user updates their own loan.
     * @deny (update) Authenticated user attempts to update a different customer's loan.
     * @allow (delete) Authenticated user deletes their own loan.
     * @deny (delete) Authenticated user attempts to delete a different customer's loan.
     * @principle Enforces document ownership for writes; restricts reads to owner.
     */
    match /customers/{customerId}/loans/{loanId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);

      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Rules for the /settings/{settingId} collection.
     * @path /settings/{settingId}
     * @allow (get) Any user can read settings.
     * @deny (create) No user can create settings via the client.
     * @deny (update) No user can update settings via the client.
     * @deny (delete) No user can delete settings via the client.
     * @principle Settings are publicly readable but not writable through the client.
     */
    match /settings/{settingId} {
      allow get: if true;
      allow list: if true;

      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}